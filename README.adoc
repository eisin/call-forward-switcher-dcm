# call-forward-switcher-dcm README

## 転送電話サービス転送先切り替え

call-forward-switcher-dcmは、NTTドコモ社が提供する転送電話サービスにおける転送先変更操作を機械実行するものです。

NTTドコモ社では転送電話サービスの設定変更を、遠隔操作により行うことができます。
遠隔操作による設定変更は本来人間がダイヤル操作することを想定していると思われますが、
TwilioによるAPI電話発信により機械的にダイヤル操作することによって実現します。

## 前提事項

転送元となる電話番号がNTTドコモ社と契約していることが必要です。さらに転送電話サービスの契約と、遠隔操作の有効化が必要です。

## 処理概要

call-forward-switcher-dcmの処理概要を示します

### (1)入力チェック

オプションファイルの設定項目をチェックし、不備や書式異常があればエラーリターンします。

### (2)電話発信

TwilioによるDial APIを実行することで電話発信を行います。

ダイヤルシーケンスは下記のとおりです。

[cols=4,options=header]
|===
|No.
|動作
|所要時間
|備考

|1
|転送電話サービスへ発信
|-
|応答後次に進む

|2
|ガイダンス待ち
|6.0s
|「お客様の電話番号を入力してください」「プププ……」待ち

|3
|発信元電話番号入力
|-
|-

|4
|ガイダンス待ち
|3.0s
|「ネットワーク暗証番号を押してください」「プププ……」待ち

|5
|ネットワーク暗証番号入力
|-
|-

|6
|ガイダンス待ち
|3.0s
|「メインメニューです」「転送電話サービスの呼び出し時間設定を行うには数字の1を」「ガイダンス有無の設定を行うには数字の2を」「転送先電話番号の登録および変更を行うには数字の3を」……待ち

|7
|転送先電話番号登録・変更を示す「3」入力
|-
|-

|8
|ガイダンス待ち
|5.0s
|「転送先電話番号を入力してください」「プププ……」待ち
		
|9
|転送先電話番号入力
|-
|-

|10
|ガイダンス録音
|18.0s
|「転送先電話番号に00000000000を登録します」「よろしければシャープを、訂正するにはコメジルシを入力してください」……待ち

|11
|シャープ「#」入力
|-
|-

|12
|ガイダンス録音
|5.0s
|「設定いたしました」「メインメニューです」……待ち

|13
|電話切断
|-
|-
|===

### (3)転送先電話番号のチェック

転送電話サービスの転送先変更が確実に行われたかどうか、応答音声を音声認識させることによって行います。
転送先として設定したはずの電話番号が応答音声に含まれない場合はエラーリターンします。

* 音声認識は、Google Cloud Voice APIに応答音声を渡すことで行います。
* Google Cloud Storageに記録せず、エンコードした音声データを直接APIに渡すため、何らかの理由で60秒を超えた音声は認識できません。
* Twilioによってダイアルした電話番号と、Google Cloud Voice APIによって認識した電話番号が異なる場合にはエラーリターンします。失敗した場合は数回程度適宜リトライする必要があります。
* 音声認識の精度は100％とは言えず、手元の環境では100回に1回程度の音声認識ミスが発生します。

## 実行方法

ここではコマンドラインとしての利用方法を示します。ライブラリとしての利用は、switch.pyのソースコードを確認ください。

python switch.py --forwardto 09000000000 [--config /path/to/switch.cfg]

### 転送先電話番号(--forwardto)

転送先電話番号を09000000000の形式で記載します。

ハイフンや国番号は記載できません。

### オプションファイル(--config)

デフォルトではカレントディレクトリにあるswitch.cfgを参照します。

switch.cfgはテキストファイルで、WindowsのINIファイルに似た書式を読み込みます（ConfigParserが解析します）。
セクションを表す [config] 行につづいて、名称=値 を書式とした設定値を記載します。

[cols=4,options=header]
|===
|No.
|名称
|値
|備考

|1
|twilio_sid
|TwilioのアプリケーションSIDを記載します
|ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxの形式です。

|2
|twilio_token
|Twilioのアクセストークンを記載します
|xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxの形式です。

|3
|twilio_phone_number
|Twilioによって発信する発信元電話番号を記載します
|+815000000000の形式です（050-0000-0000の場合）。 +
 日本国以外の電話番号についてはテストしていません。

|4
|transfer_service_dcm_phone_number
|転送電話サービスの電話番号を記載します
|+819000000000の形式です（090-0000000の場合）。

|5
|forward_from_phone_number
|転送元となる電話番号を記載します
|090000000000の形式です（090-0000-0000の場合）。 +
 転送元となる電話番号とは、この番号に着信があると転送先電話番号に転送される、もとの番号のことを言います

|6
|forward_from_network_pass
|転送元となる電話番号のネットワーク暗証番号を記載します
|0000の形式です

|7
|record_entire
|trueを指定するとTwilioの通話全体の音声を録音します。 +
 falseを指定すると録音しません。
|録音した音声は、処理に不具合があった場合の確認に利用できます。
 call-forward-switcher-dcmの動作として通話全体の録音は必須ではありません。

|8
|record_response
|trueを指定するとTwilioの通話において転送電話サービス側が読み上げる音声による結果チェック箇所を録音します。 +
 falseを指定すると録音しません。
|trueを指定して結果チェックを行うことを推奨します。
 結果チェックを行わない場合、処理の正常終了を確認できません。
 
|9
|google_api_key
|Google Cloud PlatformのAPIキーを指定します。
|XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXの形式です。

|===

## 活用方法の例

call-forward-switcher-dcmの活用方法について例を示します。

* 営業時間内と営業時間外とで、転送先変更を行うことによって、電話連絡を受け付けるメンバを変更する。
* 日次や週次などの定期的なタイミングで、電話連絡を受け付けるメンバをローテーションさせる。

## 運用上の注意点

### Twilioに関する注意点

* Twilioの利用料金は、1日1回程度利用するものとして電話番号料月額108円＋発信料500円／月程度が目安となります。

* Twilioの障害検知については、Twilioコンソール→設定→ステータスE-mailよりメール通知設定を行うことを推奨します。サービス稼働状況に何らかの問題があった場合には、メールでの通知を受け取った上でウェブサイトより詳細状況を確認します。
  https://status.twilio.com/

* Twilioで録音した音声は、URLが知られることのない限りアクセスはできないものの、デフォルトではワールドワイドに公開されます。
  必要に応じて、
  Twilioコンソール→Programmable Voice→設定→Enforce HTTP Auth on Media URLs
  より録音音声アクセス時の認証を必須とすると良いでしょう。
  call-forward-switcher-dcmは認証アクセスに対応しています。

* Twilioによる発信の途中で音声録音を行うためにTwilio社の提供する http://twimlets.com を利用しています。
  当該サイトの障害時にcall-forward-switcher-dcmは利用できません。

### Google Cloudに関する注意点

* Google Cloud Voice APIによる音声認識アルゴリズムの詳細は予告および通知なく変更されるようです。 +
  日々動作状況を確認し、アルゴリズムの詳細変更による認識率の低下が発生する場合にはチェック機能のチューニングが必要です。
  音声認識仕様の変更があった場合に、チューニングが完了するまでの間一時的に本機能が利用できなくなる可能性があるため、代替手段を検討しておく必要があります。
  （一時的に手作業で転送先を変更するなど）

* Google Cloud Voice APIの利用料金は、1日1回程度利用するものとして日本円に換算すると無料期間の範囲内～数円／月程度が目安となります。

## ライセンス

http://www.apache.org/licenses/LICENSE-2.0

