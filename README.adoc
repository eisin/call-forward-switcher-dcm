# call-forward-switcher-jp README

## 転送電話サービス転送先切り替え

call-forward-switcher-jpは、日本の携帯電話キャリアが提供する転送電話サービスにおける転送先変更操作を機械実行するものです。

日本の携帯電話キャリアでは転送電話サービスの設定変更を、遠隔操作により行うことができます。
遠隔操作による設定変更は本来人間がダイヤル操作することを想定していると思われますが、
TwilioによるAPI電話発信により機械的にダイヤル操作することによって実現します。

現在対応しているのはNTTドコモ社およびKDDI社（au）の2種類となります。

## 前提事項

転送元となる電話番号がNTTドコモ社あるいはKDDI社と契約していることが必要です。さらに転送電話サービスの契約と、遠隔操作の有効化が必要です。

携帯電話番号がどの携帯電話キャリアに紐づくものなのか判定する機能はありません。本機能を呼び出す際に使い分ける必要があります。

## 処理概要

call-forward-switcher-jpの処理概要を示します

### (1)入力チェック

オプションファイルの設定項目をチェックし、不備や書式異常があればエラーリターンします。

### (2-1)電話発信（NTTドコモ社）

TwilioによるDial APIを実行することで電話発信を行います。

ダイヤルシーケンスは下記のとおりです。

[cols=4,options=header]
|===
|No.
|動作
|所要時間
|備考

|1
|転送電話サービスへ発信
|-
|応答後次に進む

|2
|ガイダンス待ち
|6.0s
|「お客様の電話番号を入力してください」 +
  「プププ……」待ち

|3
|発信元電話番号入力
|-
|-

|4
|ガイダンス待ち
|3.0s
|「ネットワーク暗証番号を押してください」 +
  「プププ……」待ち

|5
|ネットワーク暗証番号入力
|-
|-

|6
|ガイダンス待ち
|3.0s
|「メインメニューです」 +
  「転送電話サービスの呼び出し時間設定を行うには数字の1を」 +
  「ガイダンス有無の設定を行うには数字の2を」 +
  「転送先電話番号の登録および変更を行うには数字の3を」……待ち

|7
|転送先電話番号登録・変更を示す「3」入力
|-
|-

|8
|ガイダンス待ち
|5.0s
|「転送先電話番号を入力してください」「プププ……」待ち
		
|9
|転送先電話番号入力
|-
|-

|10
|ガイダンス録音
|18.0s
|「転送先電話番号に00000000000を登録します」 +
  「よろしければシャープを、訂正するにはコメジルシを入力してください」……待ち

|11
|シャープ「#」入力
|-
|-

|12
|ガイダンス録音
|5.0s
|「設定いたしました」 +
  「メインメニューです」……待ち

|13
|電話切断
|-
|-
|===

### (2-2)電話発信（KDDI社）

TwilioによるDial APIを実行することで電話発信を行います。

ダイヤルシーケンスは下記のとおりです。

[cols=4,options=header]
|===
|No.
|動作
|所要時間
|備考

|1
|転送電話サービスへ発信
|-
|応答後次に進む

|2
|ガイダンス待ち
|9.0s
|「合図の音がしましたらあなたの番号を入力してください」 +
  「ポーン」待ち

|3
|発信元電話番号入力
|-
|-

|4
|ガイダンス待ち
|19.0s
|「電話番号はxxxxxxxxxxxxですね」 +
  「合図の音がしましたら暗証番号を押してください」 +
  「ポーン」待ち

|5
|暗証番号入力
|-
|-

|6
|ガイダンス待ち
|8.0s
|「合図の音がしましたら転送先の電話番号を入力してください」 +
  「ポーン」待ち

|7
|転送先電話番号入力
|-
|-

|8
|ガイダンス録音
|16.0s
|「転送先電話番号は00000000000ですね」 +
  「合図の音に続いてよろしければシャープを、訂正される場合はホシジルシを入力してください」 +
  「ポーン」待ち

|9
|シャープ「#」入力
|-
|-

|10
|ガイダンス録音
|5.0s
|「かかってきた電話を全て転送します」

|11
|電話切断
|-
|-
|===

### (3)転送先電話番号のチェック

転送電話サービスの転送先変更が確実に行われたかどうか、応答音声を音声認識させることによって行います。
転送先として設定したはずの電話番号が応答音声に含まれない場合はエラーリターンします。

* 音声認識は、Google Cloud Voice APIに応答音声を渡すことで行います。
* Google Cloud Storageに記録せず、エンコードした音声データを直接APIに渡すため、何らかの理由で60秒を超えた音声は認識できません。
* Twilioによってダイアルした電話番号と、Google Cloud Voice APIによって認識した電話番号が異なる場合にはエラーリターンします。失敗した場合は数回程度適宜リトライする必要があります。
* 音声認識の精度は100％とは言えず、手元の環境では100回に1回程度の音声認識ミスが発生します。

## 実行方法

ここではコマンドラインとしての利用方法を示します。ライブラリとしての利用は、switch.pyのソースコードを確認ください。

python switch.py --forwardto 09000000000 [--config /path/to/switch.cfg]

### 転送先電話番号(--forwardto)

転送先電話番号を09000000000の形式で記載します。

ハイフンや国番号は記載できません。

### オプションファイル(--config)

デフォルトではカレントディレクトリにあるswitch.cfgを参照します。

switch.cfgはテキストファイルで、WindowsのINIファイルに似た書式を読み込みます（ConfigParserが解析します）。
セクションを表す [config] 行につづいて、名称=値 を書式とした設定値を記載します。

[cols=4,options=header]
|===
|No.
|名称
|値
|備考

|1
|twilio_sid
|TwilioのアプリケーションSIDを記載します
|ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxの形式です。

|2
|twilio_token
|Twilioのアクセストークンを記載します
|xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxの形式です。

|3
|twilio_phone_number
|Twilioによって発信する発信元電話番号を記載します
|+815000000000の形式です（050-0000-0000の場合）。 +
 日本国以外の電話番号についてはテストしていません。

|4
|transfer_service_dcm_phone_number
|NTTドコモ社転送電話サービスの電話番号を記載します
|+819000000000の形式です（090-0000000の場合）。

|4
|transfer_service_dcm_phone_number
|KDDI社転送電話サービス「転送サービス開始」の電話番号を記載します
|+8190000000000の形式です（090-0000-0000の場合）。

|5
|forward_from_phone_number
|転送元となる電話番号を記載します
|090000000000の形式です（090-0000-0000の場合）。 +
 転送元となる電話番号とは、この番号に着信があると転送先電話番号に転送される、もとの番号のことを言います

|6
|forward_from_network_pass
|転送元となる電話番号のネットワーク暗証番号を記載します
|0000の形式です

|7
|record_entire
|trueを指定するとTwilioの通話全体の音声を録音します。 +
 falseを指定すると録音しません。
|録音した音声は、処理に不具合があった場合の確認に利用できます。
 call-forward-switcher-jpの動作として通話全体の録音は必須ではありません。

|8
|record_response
|trueを指定するとTwilioの通話において転送電話サービス側が読み上げる音声による結果チェック箇所を録音します。 +
 falseを指定すると録音しません。
|trueを指定して結果チェックを行うことを推奨します。
 結果チェックを行わない場合、処理の正常終了を確認できません。
 
|9
|google_api_key
|Google Cloud PlatformのAPIキーを指定します。
|XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXの形式です。

|===

## 活用方法の例と強み・弱み

call-forward-switcher-jpは、指定した電話番号に転送先を変更する処理を機械実行するものであり、これを活用した応用プログラムを作成することを想定しています。応用プログラムに考えられる例を示します。

* 営業時間内と営業時間外とで、転送先変更を行うことによって、電話連絡を受け付けるメンバを変更することができます。
* 日次や週次などの定期的なタイミングで、電話連絡を受け付けるメンバをローテーションさせることができます。
* 単純に曜日や時間のみでの判定ではなく、祝日・非営業日といったカレンダや、メンバのシフト・不在など一律ではない前提を考慮して動的に転送先を変更することができます。

類似の方式として、Twilioが提供する機能をそのまま使う（Twilioが提供する電話番号を着信用とし、着信時に宛先転送する）方式と比べて下記の利点があります。

* 発信者の番号を表示することができる。 +
  Twilioで着信転送を行うと、転送先の着信時に表示される発信電話番号はTwilioの番号となり、発信者の電話番号は直接得られません（APIを用いて取得できます）。
  call-forward-switcher-jpはキャリアの転送電話サービスを利用するため、発信者の番号を表示することができます。折り返しの応答がスムーズです。

* システム障害時に手動の設定変更による運用継続ができる。 +
  宛先転送機能プログラムに不具合があった場合、Twilioなどのサービスが障害となった場合でも、着信電話の転送設定を手動で解除したり、
  転送先を手動で変更したりすることによって運用継続ができます。

逆に、下記のようなことを実現することはできません。

* 着信したタイミングで、発信者などの情報をもとに転送先を動的に振り分ける。 +
  call-forward-switcher-jpは、着信があるよりも前にあらかじめ転送先を変更しておくものであり、着信があったタイミングで動的に振り分けることはできません。

* 着信の記録を残して活用する。 +
  call-forward-switcher-jpは、キャリアの転送電話サービスを用いて転送しており着信があったことが分かりませんので、着信の記録を残して活用することはできません。

## 運用上の注意点

### Twilioに関する注意点

* Twilioの利用料金は、1日1回程度利用するものとして電話番号料月額108円＋発信料500円／月（NTTドコモ社の場合）もしくは1,000円／月（KDDI社の場合）程度が目安となります。

* Twilioの障害検知については、Twilioコンソール→設定→ステータスE-mailよりメール通知設定を行うことを推奨します。サービス稼働状況に何らかの問題があった場合には、メールでの通知を受け取った上でウェブサイトより詳細状況を確認します。
  https://status.twilio.com/

* Twilioで録音した音声は、URLが知られることのない限りアクセスはできないものの、デフォルトではワールドワイドに公開されます。
  必要に応じて、
  Twilioコンソール→Programmable Voice→設定→Enforce HTTP Auth on Media URLs
  より録音音声アクセス時の認証を必須とすると良いでしょう。
  call-forward-switcher-jpは認証アクセスに対応しています。

* Twilioによる発信の途中で音声録音を行うためにTwilio社の提供する http://twimlets.com を利用しています。
  当該サイトの障害時にcall-forward-switcher-jpは利用できません。

### Google Cloudに関する注意点

* Google Cloud Voice APIによる音声認識アルゴリズムの詳細は予告および通知なく変更されるようです。 +
  日々動作状況を確認し、アルゴリズムの詳細変更による認識率の低下が発生する場合にはチェック機能のチューニングが必要です。
  音声認識仕様の変更があった場合に、チューニングが完了するまでの間一時的に本機能が利用できなくなる可能性があるため、代替手段を検討しておく必要があります。
  （一時的に手作業で転送先を変更するなど）

* Google Cloud Voice APIの利用料金は、1日1回程度利用するものとして日本円に換算すると無料期間の範囲内～数円／月程度が目安となります。

## ライセンス

http://www.apache.org/licenses/LICENSE-2.0

